{
	# Aucun TLS local : on laisse Cloudflare Edge gérer HTTPS
	auto_https off
}

{env.DOMAIN} {

	# ── Section protégée /labs ────────────────────────────────
	@labs_path path /labs*

	handle @labs_path {

		# Vérification JWT auprès du service d’auth
		forward_auth auth:8081 {
			uri /api/verify            # endpoint de vérification
			copy_headers Set-Cookie    # recopie l’éventuel Set-Cookie

			# ↴ Interception des 401 pour rediriger vers /
			@unauth status 401
			handle_response @unauth {
				redir / 302
			}
		}

		# Supprime /labs du chemin puis proxy vers le bureau distant
		uri strip_prefix /labs
		reverse_proxy navigateur:80 {
			header_down Cache-Control "no-store, max-age=0, must-revalidate"
			header_down Pragma "no-cache"
			header_down Expires "0"
			header_down -ETag
			header_down -Last-Modified
		}
	}

	# ── Reste du site : sert l’interface de login ─────────────
	handle {
		reverse_proxy auth:8081
	}

	encode gzip
}
